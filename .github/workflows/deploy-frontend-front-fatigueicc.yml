name: Deploy Frontend to front-fatigueicc

on:
  push:
    branches:
      - main
    paths:
      - "frontend/**"
      - ".github/workflows/deploy-frontend-front-fatigueicc.yml"
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        env:
          VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}
          VITE_DEMO_MODE: ${{ vars.VITE_DEMO_MODE }}
          VITE_TIME_ZONE: ${{ vars.VITE_TIME_ZONE }}
          VITE_TIME_LABEL: ${{ vars.VITE_TIME_LABEL }}
          VITE_AZURE_MAP_KEY: ${{ secrets.VITE_AZURE_MAP_KEY }}
          VITE_AZURE_MAP_COUNTRY: ${{ vars.VITE_AZURE_MAP_COUNTRY }}
          VITE_UI_SCALE: ${{ vars.VITE_UI_SCALE }}
        run: npm run build

      - name: Prepare runtime package for App Service
        run: |
          mkdir -p ../frontend-release
          cp -r dist/* ../frontend-release/
          cat > ../frontend-release/server.js << 'EOF'
          const http = require('http');
          const fs = require('fs');
          const path = require('path');

          const port = process.env.PORT || 8080;
          const root = __dirname;
          const mimeTypes = {
            '.html': 'text/html; charset=utf-8',
            '.js': 'application/javascript; charset=utf-8',
            '.mjs': 'application/javascript; charset=utf-8',
            '.css': 'text/css; charset=utf-8',
            '.json': 'application/json; charset=utf-8',
            '.svg': 'image/svg+xml',
            '.png': 'image/png',
            '.jpg': 'image/jpeg',
            '.jpeg': 'image/jpeg',
            '.gif': 'image/gif',
            '.ico': 'image/x-icon',
            '.woff': 'font/woff',
            '.woff2': 'font/woff2',
            '.ttf': 'font/ttf',
            '.map': 'application/json; charset=utf-8'
          };

          const sendFile = (res, filePath) => {
            fs.readFile(filePath, (err, data) => {
              if (err) {
                res.writeHead(404, { 'Content-Type': 'text/plain; charset=utf-8' });
                res.end('Not found');
                return;
              }
              const ext = path.extname(filePath).toLowerCase();
              const contentType = mimeTypes[ext] || 'application/octet-stream';
              res.writeHead(200, { 'Content-Type': contentType });
              res.end(data);
            });
          };

          const server = http.createServer((req, res) => {
            const cleanPath = (req.url || '/').split('?')[0];
            const requestedPath = cleanPath === '/' ? '/index.html' : cleanPath;
            const filePath = path.join(root, requestedPath);

            if (fs.existsSync(filePath) && fs.statSync(filePath).isFile()) {
              sendFile(res, filePath);
              return;
            }

            sendFile(res, path.join(root, 'index.html'));
          });

          server.listen(port, () => {
            console.log(`Frontend running on port ${port}`);
          });
          EOF
          cat > ../frontend-release/package.json << 'EOF'
          {
            "name": "front-fatigueicc-runtime",
            "private": true,
            "version": "1.0.0",
            "scripts": {
              "start": "node server.js"
            }
          }
          EOF

      - name: Deploy to Azure Web App (front-fatigueicc)
        uses: azure/webapps-deploy@v3
        with:
          app-name: front-fatigueicc
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_FRONT_FATIGUEICC }}
          package: frontend-release
