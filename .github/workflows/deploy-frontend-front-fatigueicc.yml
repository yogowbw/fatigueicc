name: Deploy Frontend to front-fatigueicc

on:
  push:
    branches:
      - main
    paths:
      - "frontend/**"
      - ".github/workflows/deploy-frontend-front-fatigueicc.yml"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        env:
          VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}
          VITE_DEMO_MODE: ${{ vars.VITE_DEMO_MODE }}
          VITE_TIME_ZONE: ${{ vars.VITE_TIME_ZONE }}
          VITE_TIME_LABEL: ${{ vars.VITE_TIME_LABEL }}
          VITE_AZURE_MAP_KEY: ${{ secrets.VITE_AZURE_MAP_KEY }}
          VITE_AZURE_MAP_COUNTRY: ${{ vars.VITE_AZURE_MAP_COUNTRY }}
          VITE_UI_SCALE: ${{ vars.VITE_UI_SCALE }}
        run: npm run build

      - name: Prepare runtime package for App Service
        run: |
          mkdir -p ../frontend-release
          cp -r dist/* ../frontend-release/
          cat > ../frontend-release/server.js << 'EOF'
          const http = require('http');
          const https = require('https');
          const fs = require('fs');
          const path = require('path');
          const { URL } = require('url');

          const port = process.env.PORT || 8080;
          const root = __dirname;
          const apiProxyTarget = process.env.API_PROXY_TARGET || 'https://fatigueicc.azurewebsites.net';
          const mimeTypes = {
            '.html': 'text/html; charset=utf-8',
            '.js': 'application/javascript; charset=utf-8',
            '.mjs': 'application/javascript; charset=utf-8',
            '.css': 'text/css; charset=utf-8',
            '.json': 'application/json; charset=utf-8',
            '.svg': 'image/svg+xml',
            '.png': 'image/png',
            '.jpg': 'image/jpeg',
            '.jpeg': 'image/jpeg',
            '.gif': 'image/gif',
            '.ico': 'image/x-icon',
            '.woff': 'font/woff',
            '.woff2': 'font/woff2',
            '.ttf': 'font/ttf',
            '.map': 'application/json; charset=utf-8'
          };

          const proxyApiRequest = (req, res) => {
            let targetUrl;
            try {
              targetUrl = new URL(req.url, apiProxyTarget);
            } catch (error) {
              res.writeHead(500, { 'Content-Type': 'application/json; charset=utf-8' });
              res.end(JSON.stringify({ error: 'Invalid API proxy target' }));
              return;
            }

            const transport = targetUrl.protocol === 'https:' ? https : http;
            const headers = { ...req.headers, host: targetUrl.host };

            const proxyReq = transport.request(
              {
                protocol: targetUrl.protocol,
                hostname: targetUrl.hostname,
                port: targetUrl.port || (targetUrl.protocol === 'https:' ? 443 : 80),
                method: req.method,
                path: `${targetUrl.pathname}${targetUrl.search}`,
                headers
              },
              (proxyRes) => {
                res.writeHead(proxyRes.statusCode || 502, proxyRes.headers);
                proxyRes.pipe(res, { end: true });
              }
            );

            proxyReq.on('error', () => {
              res.writeHead(502, { 'Content-Type': 'application/json; charset=utf-8' });
              res.end(JSON.stringify({ error: 'Failed to reach backend API' }));
            });

            if (req.method === 'GET' || req.method === 'HEAD') {
              proxyReq.end();
              return;
            }
            req.pipe(proxyReq, { end: true });
          };

          const sendFile = (res, filePath) => {
            fs.readFile(filePath, (err, data) => {
              if (err) {
                res.writeHead(404, { 'Content-Type': 'text/plain; charset=utf-8' });
                res.end('Not found');
                return;
              }
              const ext = path.extname(filePath).toLowerCase();
              const contentType = mimeTypes[ext] || 'application/octet-stream';
              res.writeHead(200, { 'Content-Type': contentType });
              res.end(data);
            });
          };

          const server = http.createServer((req, res) => {
            const rawPath = (req.url || '/').split('?')[0];
            const cleanPath = (() => {
              try {
                return decodeURIComponent(rawPath);
              } catch {
                return rawPath;
              }
            })();

            if (cleanPath.startsWith('/api/')) {
              proxyApiRequest(req, res);
              return;
            }

            const requestedPath = cleanPath === '/' ? '/index.html' : cleanPath;
            const filePath = path.join(root, requestedPath);

            if (fs.existsSync(filePath) && fs.statSync(filePath).isFile()) {
              sendFile(res, filePath);
              return;
            }

            sendFile(res, path.join(root, 'index.html'));
          });

          server.listen(port, () => {
            console.log(`Frontend running on port ${port}`);
          });
          EOF
          cat > ../frontend-release/package.json << 'EOF'
          {
            "name": "front-fatigueicc-runtime",
            "private": true,
            "version": "1.0.0",
            "scripts": {
              "start": "node server.js"
            }
          }
          EOF

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_81719B716BF14769957CE06AAD2976B2 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_F1FCDC50A1E84C38B357CAC356B5FA0A }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_80755064954848CF943DB6F6109D00D6 }}

      - name: Deploy to Azure Web App (front-fatigueicc)
        uses: azure/webapps-deploy@v3
        with:
          app-name: front-fatigueicc
          package: frontend-release
